"""
신혼 타겟 3년 기준 전체 재분석 및 리포트 업데이트
"""

import pandas as pd
import numpy as np
from pathlib import Path

BASE_DIR = Path(__file__).parent
CLEANED_FILE = BASE_DIR / "분석결과/pb_survey_cleaned.csv"

df_clean = pd.read_csv(CLEANED_FILE, encoding='utf-8-sig')

# 신혼 조건 3년
신혼_조건_3년 = [
    '동거 중 (결혼 계획 있음, 6개월 이후)',
    '동거 중 (결혼 계획 있음, 6개월 이내)',
    '결혼한 지 1년 이내',
    '결혼한 지 1~3년'
]

# 그룹 정의
group1 = df_clean.copy()
group2 = df_clean[df_clean['is_2인가구'] & df_clean['is_아파트']].copy()
group3 = df_clean[df_clean['is_2인가구'] & df_clean['is_아파트'] & df_clean['Q2_결혼상태'].isin(신혼_조건_3년)].copy()

groups = {
    '전체': group1,
    '2인가구+아파트': group2,
    '신혼타겟': group3
}

print("=" * 80)
print("신혼 타겟 3년 기준 상세 분석 결과")
print("=" * 80)

# 응답자 특성
print("\n[응답자 특성]")
for name, group in groups.items():
    print(f"\n{name} (n={len(group)}):")
    print(f"  평균 나이: {group['나이'].mean():.1f}세")
    print(f"  여성: {(group['성별']=='여성').sum()}명 ({(group['성별']=='여성').sum()/len(group)*100:.1f}%)")

# Q3: 침대 사용 빈도
print("\n\n[Q3. 침대 사용 빈도]")
print("| 빈도 | 전체 | 2인가구+아파트 | 신혼타겟 |")
print("|------|------|---------------|---------|")

빈도_순서 = ['거의 없다 (바로 눕거나 잠만 잔다)', '거의 매일', '주 1–2회 정도', '주 3–4회 정도', '매일, 비교적 오랜 시간 사용한다']
빈도_라벨 = ['거의 없다', '거의 매일', '주 1-2회', '주 3-4회', '매일 오랜시간']

for i, 빈도 in enumerate(빈도_순서):
    라벨 = 빈도_라벨[i]
    전체_pct = (group1['Q3_침대사용빈도']==빈도).sum() / len(group1) * 100
    group2_pct = (group2['Q3_침대사용빈도']==빈도).sum() / len(group2) * 100
    group3_pct = (group3['Q3_침대사용빈도']==빈도).sum() / len(group3) * 100
    print(f"| {라벨} | {전체_pct:.1f}% | {group2_pct:.1f}% | {group3_pct:.1f}% |")

# Q4: 머무르는 시간
print("\n\n[Q4. 한 번에 머무르는 시간] (침대 사용자만)")
print("| 시간 | 전체 | 2인가구+아파트 | 신혼타겟 |")
print("|------|------|---------------|---------|")

시간_순서 = ['1시간 이상', '30분–1시간', '15–30분', '5–15분', '5분 이내 (잠깐 휴대폰 확인 정도)']
시간_라벨 = ['1시간 이상', '30분-1시간', '15-30분', '5-15분', '5분 이내']

for i, 시간 in enumerate(시간_순서):
    라벨 = 시간_라벨[i]
    g1_사용자 = group1[group1['Q3_침대사용빈도'] != '거의 없다 (바로 눕거나 잠만 잔다)']
    g2_사용자 = group2[group2['Q3_침대사용빈도'] != '거의 없다 (바로 눕거나 잠만 잔다)']
    g3_사용자 = group3[group3['Q3_침대사용빈도'] != '거의 없다 (바로 눕거나 잠만 잔다)']
    
    if len(g1_사용자) > 0:
        전체_pct = (g1_사용자['Q4_머무르는시간']==시간).sum() / len(g1_사용자) * 100
    else:
        전체_pct = 0
    
    if len(g2_사용자) > 0:
        group2_pct = (g2_사용자['Q4_머무르는시간']==시간).sum() / len(g2_사용자) * 100
    else:
        group2_pct = 0
    
    if len(g3_사용자) > 0:
        group3_pct = (g3_사용자['Q4_머무르는시간']==시간).sum() / len(g3_사용자) * 100
    else:
        group3_pct = 0
    
    print(f"| {라벨} | {전체_pct:.1f}% | {group2_pct:.1f}% | {group3_pct:.1f}% |")

# Q5: 활동
print("\n\n[Q5. 침대에서 하는 활동] (침대 사용자만, 복수선택)")
print("| 활동 | 전체 | 2인가구+아파트 | 신혼타겟 |")
print("|------|------|---------------|---------|")

활동_cols = ['영상시청', '휴대폰', '휴식', '독서', '대화통화']
활동_라벨 = ['영상 시청', '휴대폰 사용', '휴식', '독서', '대화/통화']

for i, col in enumerate(활동_cols):
    라벨 = 활동_라벨[i]
    g1_사용자 = group1[group1['Q3_침대사용빈도'] != '거의 없다 (바로 눕거나 잠만 잔다)']
    g2_사용자 = group2[group2['Q3_침대사용빈도'] != '거의 없다 (바로 눕거나 잠만 잔다)']
    g3_사용자 = group3[group3['Q3_침대사용빈도'] != '거의 없다 (바로 눕거나 잠만 잔다)']
    
    전체_pct = (g1_사용자[f'Q5_활동_{col}'].notna() & (g1_사용자[f'Q5_활동_{col}'] != '')).sum() / len(g1_사용자) * 100
    group2_pct = (g2_사용자[f'Q5_활동_{col}'].notna() & (g2_사용자[f'Q5_활동_{col}'] != '')).sum() / len(g2_사용자) * 100
    group3_pct = (g3_사용자[f'Q5_활동_{col}'].notna() & (g3_사용자[f'Q5_활동_{col}'] != '')).sum() / len(g3_사용자) * 100
    
    print(f"| {라벨} | {전체_pct:.1f}% | {group2_pct:.1f}% | {group3_pct:.1f}% |")

# Q7: 헤드보드 중요도
print("\n\n[Q7. 헤드보드 디자인 중요도]")
print("| 중요도 | 전체 | 2인가구+아파트 | 신혼타겟 |")
print("|--------|------|---------------|---------|")

중요도_순서 = ['매우 중요함', '어느 정도 중요함', '보통이다', '별로 중요하지 않음', '전혀 중요하지 않음']
중요도_라벨 = ['매우 중요', '어느정도 중요', '보통', '별로 중요하지 않음', '전혀 중요하지 않음']

for i, 중요도 in enumerate(중요도_순서):
    라벨 = 중요도_라벨[i]
    전체_pct = (group1['Q7_헤드보드중요도']==중요도).sum() / len(group1) * 100
    group2_pct = (group2['Q7_헤드보드중요도']==중요도).sum() / len(group2) * 100
    group3_pct = (group3['Q7_헤드보드중요도']==중요도).sum() / len(group3) * 100
    print(f"| {라벨} | {전체_pct:.1f}% | {group2_pct:.1f}% | {group3_pct:.1f}% |")

# 중요 합계
전체_중요 = group1['Q7_헤드보드중요도'].isin(['매우 중요함', '어느 정도 중요함']).sum() / len(group1) * 100
group2_중요 = group2['Q7_헤드보드중요도'].isin(['매우 중요함', '어느 정도 중요함']).sum() / len(group2) * 100
group3_중요 = group3['Q7_헤드보드중요도'].isin(['매우 중요함', '어느 정도 중요함']).sum() / len(group3) * 100
print(f"| **중요 합계** | **{전체_중요:.1f}%** | **{group2_중요:.1f}%** | **{group3_중요:.1f}%** |")

# Q8: 헤드보드 형태
print("\n\n[Q8. 헤드보드 형태]")
print("| 형태 | 전체 | 2인가구+아파트 | 신혼타겟 |")
print("|------|------|---------------|---------|")

형태_순서 = ['나무/철제 등 (하드 타입)', '패브릭/쿠션 등 (소프트 타입)', '없음(무헤드)']
형태_라벨 = ['하드 타입', '소프트 타입', '없음(무헤드)']

for i, 형태 in enumerate(형태_순서):
    라벨 = 형태_라벨[i]
    전체_pct = (group1['Q8_헤드보드형태']==형태).sum() / len(group1) * 100
    group2_pct = (group2['Q8_헤드보드형태']==형태).sum() / len(group2) * 100
    group3_pct = (group3['Q8_헤드보드형태']==형태).sum() / len(group3) * 100
    print(f"| {라벨} | {전체_pct:.1f}% | {group2_pct:.1f}% | {group3_pct:.1f}% |")

# Q9: 헤드보드 만족도
print("\n\n[Q9. 헤드보드 편안함 만족도] (무헤드 제외)")
print("| 만족도 | 전체 | 2인가구+아파트 | 신혼타겟 |")
print("|--------|------|---------------|---------|")

g1_유헤드 = group1[group1['Q8_헤드보드형태'] != '없음(무헤드)']
g2_유헤드 = group2[group2['Q8_헤드보드형태'] != '없음(무헤드)']
g3_유헤드 = group3[group3['Q8_헤드보드형태'] != '없음(무헤드)']

만족도_순서 = ['매우 그렇다', '어느 정도 그렇다', '보통이다', '그렇지 않다', '전혀 그렇지 않다']

for 만족도 in 만족도_순서:
    전체_pct = (g1_유헤드['Q9_헤드보드편안함']==만족도).sum() / len(g1_유헤드) * 100
    group2_pct = (g2_유헤드['Q9_헤드보드편안함']==만족도).sum() / len(g2_유헤드) * 100
    group3_pct = (g3_유헤드['Q9_헤드보드편안함']==만족도).sum() / len(g3_유헤드) * 100
    print(f"| {만족도} | {전체_pct:.1f}% | {group2_pct:.1f}% | {group3_pct:.1f}% |")

# 만족 합계
전체_만족 = g1_유헤드['Q9_헤드보드편안함'].isin(['매우 그렇다', '어느 정도 그렇다']).sum() / len(g1_유헤드) * 100
group2_만족 = g2_유헤드['Q9_헤드보드편안함'].isin(['매우 그렇다', '어느 정도 그렇다']).sum() / len(g2_유헤드) * 100
group3_만족 = g3_유헤드['Q9_헤드보드편안함'].isin(['매우 그렇다', '어느 정도 그렇다']).sum() / len(g3_유헤드) * 100
print(f"| **만족 합계** | **{전체_만족:.1f}%** | **{group2_만족:.1f}%** | **{group3_만족:.1f}%** |")

# 교차 분석
print("\n\n[교차 분석: TV 보유 × 영상 시청]")
print("| 그룹 | TV 있음 | TV 없음 | 차이 |")
print("|------|---------|---------|------|")

for name, group in groups.items():
    사용자 = group[group['Q3_침대사용빈도'] != '거의 없다 (바로 눕거나 잠만 잔다)']
    tv보유 = (사용자['Q6_가구_TV'].notna() & (사용자['Q6_가구_TV'] != ''))
    tv없음 = ~tv보유
    
    if tv보유.sum() > 0:
        tv있음_영상 = (사용자[tv보유]['Q5_활동_영상시청'].notna() & (사용자[tv보유]['Q5_활동_영상시청'] != '')).sum()
        tv있음_pct = tv있음_영상 / tv보유.sum() * 100
    else:
        tv있음_pct = 0
    
    if tv없음.sum() > 0:
        tv없음_영상 = (사용자[tv없음]['Q5_활동_영상시청'].notna() & (사용자[tv없음]['Q5_활동_영상시청'] != '')).sum()
        tv없음_pct = tv없음_영상 / tv없음.sum() * 100
    else:
        tv없음_pct = 0
    
    차이 = tv있음_pct - tv없음_pct
    print(f"| {name} | {tv있음_pct:.1f}% | {tv없음_pct:.1f}% | +{차이:.1f}%p |")

# 헤드보드 타입 × 만족도
print("\n\n[교차 분석: 헤드보드 타입 × 만족도] (신혼 타겟)")
print("| 헤드보드 타입 | 만족 | 보통 | 불만족 |")
print("|--------------|------|------|--------|")

소프트 = g3_유헤드[g3_유헤드['Q8_헤드보드형태'] == '패브릭/쿠션 등 (소프트 타입)']
하드 = g3_유헤드[g3_유헤드['Q8_헤드보드형태'] == '나무/철제 등 (하드 타입)']

if len(소프트) > 0:
    소프트_만족 = 소프트['Q9_헤드보드편안함'].isin(['매우 그렇다', '어느 정도 그렇다']).sum() / len(소프트) * 100
    소프트_보통 = (소프트['Q9_헤드보드편안함'] == '보통이다').sum() / len(소프트) * 100
    소프트_불만 = 소프트['Q9_헤드보드편안함'].isin(['그렇지 않다', '전혀 그렇지 않다']).sum() / len(소프트) * 100
    print(f"| 소프트 타입 | {소프트_만족:.1f}% | {소프트_보통:.1f}% | {소프트_불만:.1f}% |")

if len(하드) > 0:
    하드_만족 = 하드['Q9_헤드보드편안함'].isin(['매우 그렇다', '어느 정도 그렇다']).sum() / len(하드) * 100
    하드_보통 = (하드['Q9_헤드보드편안함'] == '보통이다').sum() / len(하드) * 100
    하드_불만 = 하드['Q9_헤드보드편안함'].isin(['그렇지 않다', '전혀 그렇지 않다']).sum() / len(하드) * 100
    print(f"| 하드 타입 | {하드_만족:.1f}% | {하드_보통:.1f}% | {하드_불만:.1f}% |")

print("\n" + "=" * 80)
print("분석 완료! 위 결과를 리포트에 반영하세요.")
print("=" * 80)

